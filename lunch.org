#+TITLE: Lunch
#+STARTUP: inlineimages
#+STARTUP: showall

* Plan
** Week [0/8] [0%]
1) [ ] Sat: Butter Chicken
2) [ ] Sun: Tuna poke bowl
3) [ ] Mon: Mushroom risotto
4) [ ] Tue: Spaghetti Carbonara
5) [ ] Wed: Falafel
6) [ ] Thu: Burger
7) [ ] Fri: etc..
8) [ ] Sat: etc..
 
** Shopping List [0/5] [0%]
*** TODO Eggs
*** TODO Bread
*** TODO Milk
*** TODO Coffee
*** TODO etc..

** Operations
*** [[elisp:(lunch-reset-week)][Reset Week]]
*** [[elisp:(lunch-toggle-checkboxes)][Toggle Check Boxes]]
*** [[elisp:(lunch-clear-items)][Clear Items]]
*** [[elisp:(shopping-list-to-qr)][Generate QR Code]]

* Code
:PROPERTIES:
:VISIBILITY: folded
:END:

#+BEGIN_SRC emacs-lisp
(defun lunch-toggle-checkboxes ()
  (org-map-entries #'org-toggle-checkbox "LEVEL=2" 'file)) ; Eval C-c C-c / Enter

(defun lunch-clear-items ()
  (goto-char (point-min))
  (when (re-search-forward ".*Week.*" nil t)
    (let* ((element (org-element-at-point))
           (end     (org-element-property :end element)))
      (while (re-search-forward ".*\\[[X ]\\] [[:word:]]+: \\(.*\\)" end t)
        (replace-match "" nil nil nil 1)))))

(defun lunch-reset-week ()
  (lunch-clear-items)
  (lunch-toggle-checkboxes))
#+end_src

#+RESULTS:
: lunch-reset-week

#+begin_src emacs-lisp
(defconst qrpath
  (expand-file-name "~/notes/shopping.png"))

(defun find-shopping-items ()
  (goto-char (point-min))
  (when (re-search-forward ".*Shopping List.*" nil t)
      (let* ((element (org-element-at-point))
             (end     (org-element-property :end element))
             items    '())
        (while (re-search-forward "\\*\\* TODO \\(.*\\)" end t)
          (push (match-string 1) items))
        (mapconcat #'identity (nreverse items) "\n"))))

;; needs sudo apt-get install qrencode
(defun shopping-list-to-qr ()
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (let ((items (find-shopping-items)))
      (when items
        (call-process "qrencode" nil nil nil "-o" qrpath "-s" "10" items)
        (goto-char (point-max))
        (insert (format "\n[[file:%s]]" qrpath))
        (org-display-inline-images t t)))))
#+end_src

#+RESULTS:
: shopping-list-to-qr

# Local variables:
# eval: (org-babel-execute-buffer)
# End:
